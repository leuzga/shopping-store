<div class="product-list-container">
  <!-- Persistent Header (Title + Filter + Pagination) -->
  <div class="sticky-header">
    <div class="flex flex-col md:flex-row justify-between items-center gap-4">
      <h1 class="product-list-title">{{ messages.TITLES.LIST }}</h1>

      <!-- Right Section: Filter + Pagination -->
      <div class="header-right-section">
        <!-- Product Filter Component -->
        <app-product-filter></app-product-filter>

        <!-- DaisyUI Pagination (Hidden when searching to prevent data mixing) -->
        @if (!searchService.query()) {
          <div class="pagination-join">
            <button class="join-item btn btn-sm md:btn-md" [disabled]="currentPage() === 1" (click)="goToPage(currentPage() - 1)">«</button>
            <button class="join-item btn btn-sm md:btn-md no-animation font-bold">
              {{ messages.LABELS.PAGE_INFO(currentPage(), displayedTotalPages()) }}
            </button>
            <button class="join-item btn btn-sm md:btn-md" [disabled]="currentPage() === displayedTotalPages()" (click)="goToPage(currentPage() + 1)">»</button>
          </div>
        }
      </div>
    </div>
  </div>

  <!-- Product Grid (displays filtered products, pagination uses original products array) -->
  <div class="product-grid" #gridContainer>
    @for (product of displayProducts(); track product.id; let index = $index) {
      <app-product-card
        [product]="product"
        (addToCart)="onAddToCart($event)"
        [id]="'product-' + index"
        [attr.data-product-index]="index" />
    }
  </div>

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-container">
      <span class="loading loading-dots loading-lg text-primary"></span>
    </div>
  }

  <!-- Intersection Observer Trigger (Disabled when searching) -->
  @if (!searchService.query()) {
    <div #loadMoreTrigger class="scroll-trigger"></div>
  }

  <!-- End of List -->
  @if (hasReachedEnd() && !isLoading() && !searchService.query()) {
    <div class="end-list-alert">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
      <span>{{ messages.STATUS.END_OF_LIST }} (Total: {{ totalProducts() }} {{ messages.UNIT.PRODUCTS }})</span>
    </div>
  }

  <!-- No Search Results -->
  @if (searchService.query() && displayProducts().length === 0 && !isLoading()) {
    <div class="alert alert-warning shadow-sm mt-8 animate-in fade-in zoom-in duration-300">
      <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
      <span>No se encontraron productos para "<strong>{{ searchService.query() }}</strong>". Intenta con otros términos.</span>
      <button class="btn btn-sm btn-ghost underline" (click)="searchService.clearSearch()">Limpiar búsqueda</button>
    </div>
  }
</div>
